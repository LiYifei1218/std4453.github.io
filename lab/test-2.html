<html>
<head>
	<title>Test 2 - std4453</title>

	<script src="//cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
	<link rel="import" href="bokeh/bokeh.html">
	<style>
		body {
			margin: 0;
			padding: 0;
		}
		canvas {
			width: 100%;
			height: 100%;
		}
	</style>
</head>

<body>
	<script>
var context={};

function onResize() {
	context.renderer.setSize(window.innerWidth, window.innerHeight);
	context.width = window.innerWidth;
	context.height = window.innerHeight;
}

function init() {
	context.scene = new THREE.Scene();
	
	context.renderer = new THREE.WebGLRenderer({
		clearColor: 0xcfcfcf,
	});
	// context.renderer.setClearColor(0xb4b4b4, 1);
	onResize();
	$(window).resize(onResize);
	document.body.appendChild(context.renderer.domElement);

	var width = window.innerWidth,height = window.innerHeight;
	context.camera = new THREE.PerspectiveCamera(0, width / height, 0.01, 100);
	context.camera.position.z = -2;
	context.camera.focalLength = 45;
	context.camera.frameSize = 32;
	context.camera.setLens(context.camera.focalLength, context.camera.frameSize);

	context.controls = new THREE.OrbitControls(context.camera, context.renderer.domElement);
	context.controls.autoRotate = true;

	// setup lighting
	context.lights = [];

	var ambient = new THREE.AmbientLight(0x4f4f4f);
	context.lights.push(ambient);
	context.scene.add(ambient);

	var toplight = new THREE.DirectionalLight(0xFFFFFF, 1);
	toplight.position.set(0, 15, 5);
	context.lights.push(toplight);
	context.scene.add(toplight);

	var sidelight = new THREE.DirectionalLight(0x59DDFF, .5);
	sidelight.position.set(-10, 5, -2);
	context.lights.push(sidelight);
	context.scene.add(sidelight);

	var bottomlight =  new THREE.DirectionalLight(0xFF30A8, .5);
	bottomlight.position.set(5, -15, 5);
	context.lights.push(bottomlight);
	context.scene.add(bottomlight);

	// add meshes
	var objects=300;
	for (var i=0;i<objects;++i) {
		var geo = new THREE.OctahedronGeometry(.2);
		var mat = new THREE.MeshPhongMaterial({
			color: 0xffffff,
			shading: THREE.FlatShading
		});
		var mesh = new THREE.Mesh(geo, mat);

		var x = Math.random() * 10 - 5;
		var y = Math.random() * 10 - 5;
		var z = Math.random() * 10 - 5;
		mesh.position.set(x, y, z);
		mesh.scale.y = Math.sqrt(3);

		context.scene.add(mesh);
	}

	var conf = {
		'focalDepth': 5,
		'fstop': 22.0,
		'maxblur': 3.0,
		'CoC': 0.02,
		'threshold': 0.5,
		'gain': 0.2,
		'bias': 0.5,
	};
	initBokeh(context, conf);
}

var bokehEnabled = true;

function render() {
	requestAnimationFrame(render);
    update();

    if (bokehEnabled) {
		context.scene.overrideMaterial = context.depthMaterial;
		context.renderer.render(context.scene, context.camera, context.depthTarget);
		context.scene.overrideMaterial = null;

		renderBokeh(context);
	} else
		context.renderer.render(context.scene, context.camera);
}

function update() {
	context.controls.update();
}

init();
render();
	</script>
</body>
</html>